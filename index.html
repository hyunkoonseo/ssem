<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>êµë³µ ë¯¸ì°©ìš© ê´€ë¦¬</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f9f9f9;
      padding: 30px;
      color: #333;
    }
    h1 { font-size: 28px; margin-bottom: 20px; }
    label, select, input[type="date"], input[type="text"], input[type="number"] {
      font-size: 16px; margin-right: 10px;
    }
    input[type="file"] { font-size: 14px; }
    button {
      background-color: #007bff; border: none; color: white;
      padding: 8px 14px; margin: 6px 4px; font-size: 14px;
      cursor: pointer; border-radius: 4px;
    }
    button:hover { background-color: #0056b3; }
    .section {
      margin-top: 40px; background: #fff; padding: 20px;
      border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    table {
      width: 100%; border-collapse: collapse; margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd; padding: 8px;
    }
    th { background-color: #f0f4f8; }
    .red { background-color: #ffdddd; font-weight: bold; }
    .orange { background-color: #fff0cc; font-weight: bold; }
    canvas { margin-top: 40px; }
  </style>
</head>
<body>
  <h1>í¬ê³¡ê³ ë“±í•™êµ êµë³µ ë¯¸ì°©ìš© í•™ìƒ ê´€ë¦¬(ver.2025 í•™ìƒìì¹˜ì•ˆì „ë¶€)</h1>

  <label>ë‚ ì§œ ì„ íƒ: <input type="date" id="dateInput"></label><br><br>

  <label>í•™ìƒ ëª©ë¡ Excel ì—…ë¡œë“œ: <input type="file" id="fileInput" accept=".xlsx"></label>
  <button onclick="exportToExcel()">ì—‘ì…€ë¡œ ì €ì¥</button>
  <button onclick="saveToServer()">ì„œë²„ë¡œ ì €ì¥</button>
  <button onclick="loadFromServer()">ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
  <br><br>

  <label>í•™ë…„/ë°˜ í•„í„°:
    <select id="filterSelect" onchange="renderByClass()">
      <option value="">ì „ì²´ ë³´ê¸°</option>
    </select>
  </label>

  <label style="margin-left: 20px;">ì´ë¦„ ê²€ìƒ‰:
    <input type="text" id="searchInput" oninput="renderByClass()" placeholder="ì´ë¦„ ì…ë ¥">
  </label>

  <label style="margin-left: 20px;">ìœ„ë°˜ íšŸìˆ˜:
    <input type="range" id="minCountInput" min="1" max="10" value="5" oninput="updateMinCountLabel()" />
    <span id="minCountDisplay">5</span>íšŒ ì´ìƒ
  </label>
  <button id="toggleHighFilter" onclick="toggleHighFilter()">í•´ë‹¹ í•™ìƒ í•„í„° ì ìš©</button>

  <div id="classSections"></div>
  <canvas id="monthlyChart" width="600" height="300"></canvas>

  <script>
    const SERVER_URL = "https://script.google.com/macros/s/https://script.google.com/macros/s/AKfycbxanXk9Ty1Ao7YwvVkRTiNjs9eI3UsH8XVtDPkbwOMohL6DD8SjFi5efMKDvGndEN8/exec"; // 

    let students = JSON.parse(localStorage.getItem("students")) || [];
    let grouped = {};
    let showOnlyHigh = false;
    let minViolationCount = 5;

    document.getElementById("fileInput").addEventListener("change", function(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function(event) {
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(sheet);
        const newStudents = jsonData.map(row => ({
          grade: row['í•™ë…„'],
          class: row['ë°˜'],
          number: row['ë²ˆí˜¸'],
          name: row['ì´ë¦„'],
          count: 0,
          dates: []
        }));
        let addedCount = 0;
        newStudents.forEach(ns => {
          const exists = students.find(s =>
            s.grade == ns.grade && s.class == ns.class && s.number == ns.number
          );
          if (!exists) {
            students.push(ns);
            addedCount++;
          }
        });
        alert(`ìƒˆë¡œ ì¶”ê°€ëœ í•™ìƒ ìˆ˜: ${addedCount}ëª…`);
        saveAndRender();
      };
      reader.readAsArrayBuffer(file);
    });

    function saveAndRender() {
      const selectedClass = document.getElementById("filterSelect").value;
      const searchKeyword = document.getElementById("searchInput").value;
      saveToLocal();
      updateFilter();
      document.getElementById("filterSelect").value = selectedClass;
      document.getElementById("searchInput").value = searchKeyword;
      renderByClass();
      updateChart();
    }

    function updateFilter() {
      const select = document.getElementById("filterSelect");
      const unique = [...new Set(students.map(s => `${s.grade}í•™ë…„ ${s.class}ë°˜`))];
      select.innerHTML = '<option value="">ì „ì²´ ë³´ê¸°</option>' + unique.map(k => `<option value="${k}">${k}</option>`).join("");
    }

    function toggleHighFilter() {
      const selectedClass = document.getElementById("filterSelect").value;
      const searchKeyword = document.getElementById("searchInput").value;

      minViolationCount = parseInt(document.getElementById("minCountInput").value) || 1;
      showOnlyHigh = !showOnlyHigh;

      const btn = document.getElementById("toggleHighFilter");
      btn.textContent = showOnlyHigh ? "ì „ì²´ ë³´ê¸°ë¡œ ëŒì•„ê°€ê¸°" : "ìœ„ë°˜ì í•„í„° ì ìš©";

      document.getElementById("filterSelect").value = selectedClass;
      document.getElementById("searchInput").value = searchKeyword;

      renderByClass();
      updateChart();
    }

    function updateMinCountLabel() {
      const value = document.getElementById("minCountInput").value;
      document.getElementById("minCountDisplay").textContent = value;
    }

    function renderByClass() {
      grouped = {};
      const filter = document.getElementById("filterSelect").value;
      const searchKeyword = document.getElementById("searchInput").value.trim();

      students.forEach(s => {
        const key = `${s.grade}í•™ë…„ ${s.class}ë°˜`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(s);
      });

      const container = document.getElementById("classSections");
      container.innerHTML = "";

      Object.entries(grouped).forEach(([key, classStudents]) => {
        if (filter && filter !== key) return;

        const filteredStudents = classStudents.filter(student =>
          student.name.includes(searchKeyword) &&
          (!showOnlyHigh || student.count >= minViolationCount)
        );
        if (filteredStudents.length === 0) return;

        const section = document.createElement("div");
        section.className = "section";
        section.innerHTML = `<h2>${key}</h2>`;
        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th>ë²ˆí˜¸</th><th>ì´ë¦„</th><th>ë¯¸ì°©ìš©</th><th>ëˆ„ì  íšŸìˆ˜</th><th>ë¯¸ì°©ìš© ë‚ ì§œ</th>
            </tr>
          </thead>
          <tbody>
            ${filteredStudents.map(student => {
              const id = `${student.grade}_${student.class}_${student.number}`;
              const date = document.getElementById("dateInput").value;
              const checked = student.dates.includes(date);
              return `
                <tr>
                  <td>${student.number}</td>
                  <td>${student.name}</td>
                  <td><input type="checkbox" data-id="${id}" ${checked ? 'checked' : ''}></td>
                  <td class="${student.count >= 5 ? 'red' : student.count >= 3 ? 'orange' : ''}">${student.count}</td>
                  <td>${student.dates.join(", ")}</td>
                </tr>`;
            }).join("")}
          </tbody>
        `;
        section.appendChild(table);
        container.appendChild(section);
      });

      document.querySelectorAll("input[type='checkbox']").forEach(cb => {
        cb.addEventListener("change", e => {
          const idParts = e.target.dataset.id.split("_");
          const student = students.find(s => s.grade == idParts[0] && s.class == idParts[1] && s.number == idParts[2]);
          handleCheck(e, student);
        });
      });
    }

    function handleCheck(event, student) {
      const date = document.getElementById("dateInput").value;
      if (!date) {
        alert("ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!");
        event.target.checked = student.dates.includes(date);
        return;
      }
      const isMarked = student.dates.includes(date);
      if (event.target.checked && !isMarked) {
        student.dates.push(date);
        student.count++;
      } else if (!event.target.checked && isMarked) {
        student.dates = student.dates.filter(d => d !== date);
        student.count--;
      }
      saveAndRender();
    }

    function saveToLocal() {
      localStorage.setItem("students", JSON.stringify(students));
    }

    function exportToExcel() {
      const exportData = students.map(s => ({
        í•™ë…„: s.grade,
        ë°˜: s.class,
        ë²ˆí˜¸: s.number,
        ì´ë¦„: s.name,
        ëˆ„ì íšŸìˆ˜: s.count,
        ë¯¸ì°©ìš©ë‚ ì§œ: s.dates.join(", ")
      }));
      const worksheet = XLSX.utils.json_to_sheet(exportData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "ë¯¸ì°©ìš©í˜„í™©");
      XLSX.writeFile(workbook, `êµë³µë¯¸ì°©ìš©í˜„í™©_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    function saveToServer() {
      fetch(SERVER_URL, {
        method: "POST",
        body: JSON.stringify(students),
        headers: { "Content-Type": "application/json" }
      })
      .then(res => res.text())
      .then(msg => alert("âœ… ì„œë²„ ì €ì¥ ì™„ë£Œ"))
      .catch(err => alert("âŒ ì €ì¥ ì‹¤íŒ¨: " + err));
    }

    function loadFromServer() {
      fetch(SERVER_URL)
        .then(res => res.json())
        .then(data => {
          students = data.map(s => ({
            grade: s["í•™ë…„"],
            class: s["ë°˜"],
            number: s["ë²ˆí˜¸"],
            name: s["ì´ë¦„"],
            count: parseInt(s["ëˆ„ì íšŸìˆ˜"] || 0),
            dates: (s["ë¯¸ì°©ìš©ë‚ ì§œ"] || "").split(",").map(d => d.trim()).filter(d => d)
          }));
          saveAndRender();
          alert("ğŸ“¥ ì„œë²„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ");
        })
        .catch(err => alert("âŒ ì„œë²„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + err));
    }

    function getRandomColor() {
      const r = Math.floor(Math.random() * 156) + 100;
      const g = Math.floor(Math.random() * 156) + 100;
      const b = Math.floor(Math.random() * 156) + 100;
      return `rgba(${r}, ${g}, ${b}, 0.6)`;
    }

    function updateChart() {
      const monthMap = {};
      const filter = document.getElementById("filterSelect").value;
      const searchKeyword = document.getElementById("searchInput").value.trim();
      students.forEach(s => {
        const key = `${s.grade}í•™ë…„ ${s.class}ë°˜`;
        if (filter && filter !== key) return;
        if (!s.name.includes(searchKeyword)) return;
        if (showOnlyHigh && s.count < minViolationCount) return;
        s.dates.forEach(date => {
          const month = date.slice(0, 7);
          if (!monthMap[month]) monthMap[month] = 0;
          monthMap[month]++;
        });
      });
      const labels = Object.keys(monthMap);
      const values = Object.values(monthMap);
      const colors = labels.map(() => getRandomColor());

      if (window.chart) window.chart.destroy();
      const ctx = document.getElementById('monthlyChart').getContext('2d');
      window.chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'ì›”ë³„ ë¯¸ì°©ìš© ê±´ìˆ˜',
            data: values,
            backgroundColor: colors
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    window.onload = () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById("dateInput").value = today;
      updateMinCountLabel();
      updateFilter();
      loadFromServer(); // ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ìë™ ì‹¤í–‰
    };
  </script>
</body>
</html>


